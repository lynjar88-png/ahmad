<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø·Ø§Ø¨Ø® - Ù„Ù„Ù‡ÙˆØ§ØªÙ</title>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Tajawal', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        /* ===== Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ ===== */
        .login-screen {
            padding: 30px 20px;
        }

        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .login-header h1 {
            color: #333;
            font-size: 24px;
            margin-bottom: 10px;
        }

        .online-badge {
            background: #28a745;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            display: inline-block;
        }

        .login-options {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .login-option {
            flex: 1;
            padding: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
        }

        .login-option.active {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .login-option i {
            font-size: 30px;
            margin-bottom: 5px;
        }

        .login-option.office i { color: #667eea; }
        .login-option.factory i { color: #25d366; }

        .password-input {
            margin-bottom: 20px;
        }

        .password-input input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
        }

        .btn-login {
            width: 100%;
            padding: 15px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }

        .error {
            color: #dc3545;
            text-align: center;
            margin-top: 10px;
        }

        /* ===== Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ===== */
        .header {
            background: #2b2b2b;
            color: white;
            padding: 15px;
            text-align: center;
            position: relative;
        }

        .mode-badge {
            background: #ffd700;
            color: #333;
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 12px;
            margin-right: 5px;
        }

        .logout-btn {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
        }

        /* Ø²Ø± Ø§Ù„Ø¥Ø¶Ø§ÙØ© */
        .add-btn {
            background: #ffd700;
            color: #333;
            border: none;
            padding: 15px;
            width: calc(100% - 20px);
            margin: 10px;
            border-radius: 30px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }

        /* Ø´Ø±ÙŠØ· Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª */
        .notifications {
            background: #fff3cd;
            color: #856404;
            padding: 12px 15px;
            margin: 10px;
            border-radius: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-right: 4px solid #ffd700;
        }

        .refresh-btn {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
        }

        /* ØªØ¨ÙˆÙŠØ¨Ø§Øª */
        .tabs {
            display: flex;
            gap: 5px;
            padding: 10px;
            background: #f8f9fa;
        }

        .tab {
            flex: 1;
            padding: 10px;
            border: none;
            background: white;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
        }

        .tab.active {
            background: #667eea;
            color: white;
        }

        /* Ø¨Ø­Ø« */
        .search-box {
            padding: 10px;
        }

        .search-box input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 14px;
        }

        /* Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ */
        .projects {
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 400px;
            overflow-y: auto;
        }

        .project-card {
            background: white;
            border: 1px solid #eee;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .card-header {
            background: #667eea;
            color: white;
            padding: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .status {
            padding: 3px 8px;
            border-radius: 15px;
            font-size: 11px;
            font-weight: 600;
        }

        .status.planning { background: #fff3cd; color: #856404; }
        .status.execution { background: #cce5ff; color: #004085; }
        .status.completed { background: #d4edda; color: #155724; }

        .card-body {
            padding: 10px;
        }

        .info {
            margin-bottom: 5px;
            border-bottom: 1px dashed #eee;
            padding-bottom: 5px;
        }

        .info-label {
            color: #666;
            font-size: 11px;
        }

        .info-value {
            font-size: 13px;
            font-weight: 500;
        }

        .card-footer {
            background: #f8f9fa;
            padding: 10px;
            display: flex;
            gap: 5px;
        }

        .btn {
            flex: 1;
            border: none;
            padding: 8px;
            border-radius: 5px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-edit { background: #17a2b8; color: white; }
        .btn-whatsapp { background: #25d366; color: white; }
        .btn-delete { background: #dc3545; color: white; }
        .btn-receive { background: #ffd700; color: #333; }
        .btn-start { background: #28a745; color: white; }

        /* ===== Ù†Ø§ÙØ°Ø© Ø¥Ø¶Ø§ÙØ© Ø·Ù„Ø¨ (Ù…Ø¹Ø¯Ù„Ø© Ù„Ù„Ù‡ÙˆØ§ØªÙ) ===== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal-content {
            background-color: white;
            margin: 20px;
            padding: 20px;
            border-radius: 20px;
            max-width: 500px;
            max-height: 85vh; /* ØªØ­Ø¯ÙŠØ¯ Ø£Ù‚ØµÙ‰ Ø§Ø±ØªÙØ§Ø¹ */
            overflow-y: auto; /* ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªÙ…Ø±ÙŠØ± */
            position: relative;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #ffd700;
            position: sticky;
            top: 0;
            background: white;
            z-index: 10;
        }

        .modal-header h3 {
            color: #333;
            font-size: 18px;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 20px;
        }

        .close:hover {
            color: #ffd700;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 600;
            font-size: 13px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            background: white;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            border-color: #667eea;
            outline: none;
        }

        .phone-group {
            display: flex;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
        }

        .phone-prefix {
            background: #f0f0f0;
            padding: 12px;
            font-weight: 600;
            color: #333;
            border-left: 2px solid #e0e0e0;
            white-space: nowrap;
        }

        .phone-group input {
            border: none;
            border-radius: 0;
            flex: 1;
        }

        .phone-group input:focus {
            outline: none;
        }

        .btn-save {
            width: 100%;
            padding: 15px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
            position: sticky;
            bottom: 0;
            z-index: 10;
        }

        .btn-save:hover {
            background: #218838;
        }

        /* Ø²Ø± ØªØ­Ø¯ÙŠØ« ÙƒØ¨ÙŠØ± Ù„Ù„Ù‡ÙˆØ§ØªÙ */
        .big-refresh {
            padding: 10px;
            margin: 10px;
        }

        .big-refresh button {
            width: 100%;
            padding: 15px;
            background: #17a2b8;
            color: white;
            border: none;
            border-radius: 30px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }

        /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ù„Ù„Ù‡ÙˆØ§ØªÙ Ø§Ù„ØµØºÙŠØ±Ø© */
        @media (max-width: 380px) {
            .modal-content {
                margin: 10px;
                padding: 15px;
            }
            
            .form-group input,
            .form-group select,
            .form-group textarea,
            .phone-prefix {
                padding: 10px;
                font-size: 13px;
            }
        }
    </style>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div id="app"></div>

    <script>
        // ==================== Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase ====================
        const firebaseConfig = {
            apiKey: "AIzaSyCZfnlCBqBuxao3OTIZAK3E4-J2bAiQWHY",
            authDomain: "ahmad992.firebaseapp.com",
            projectId: "ahmad992",
            storageBucket: "ahmad992.firebasestorage.app",
            messagingSenderId: "349563855282",
            appId: "1:349563855282:web:87479b610f66afd31504ab"
        };

        // ØªÙ‡ÙŠØ¦Ø© Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        // Ù…ØªØºÙŠØ±Ø§Øª Ø¹Ø§Ù…Ø©
        let currentUser = null;
        let projects = [];
        let lastUpdate = Date.now();
        let failedAttempts = 0;

        // ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ±
        const PASSWORDS = {
            office: '1234',
            factory: '5678'
        };

        // ==================== ÙƒØ´Ù Ù†ÙˆØ¹ Ø§Ù„Ø¬Ù‡Ø§Ø² ====================
        const isMobile = /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
        const isOnline = navigator.onLine;

        // ==================== Ø¹Ø±Ø¶ Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ ====================
        function showLoginScreen() {
            document.getElementById('app').innerHTML = `
                <div class="container">
                    <div class="login-screen">
                        <div class="login-header">
                            <h1>ğŸ³ Ù…Ø·Ø§Ø¨Ø® Ø£Ø­Ù…Ø¯</h1>
                            <div class="online-badge">
                                ${isOnline ? 'âœ… Ù…ØªØµÙ„' : 'âŒ ØºÙŠØ± Ù…ØªØµÙ„'}
                            </div>
                        </div>
                        
                        <div class="login-options">
                            <div class="login-option office active" onclick="selectType('office')">
                                <i class="fas fa-briefcase"></i>
                                <div>Ø§Ù„Ù…ÙƒØªØ¨</div>
                            </div>
                            <div class="login-option factory" onclick="selectType('factory')">
                                <i class="fas fa-industry"></i>
                                <div>Ø§Ù„Ù…Ø¹Ù…Ù„</div>
                            </div>
                        </div>
                        
                        <div class="password-input">
                            <input type="password" id="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
                        </div>
                        
                        <button class="btn-login" onclick="login()">
                            Ø¯Ø®ÙˆÙ„
                        </button>
                        
                        <div id="loginError" class="error"></div>
                    </div>
                </div>
            `;
        }

        // ==================== Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ====================
        window.selectType = (type) => {
            document.querySelectorAll('.login-option').forEach(opt => {
                opt.classList.remove('active');
            });
            document.querySelector(`.login-option.${type}`).classList.add('active');
        };

        // ==================== ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ====================
        window.login = () => {
            const selected = document.querySelector('.login-option.active');
            const type = selected.classList.contains('office') ? 'office' : 'factory';
            const password = document.getElementById('password').value;
            
            if (password === PASSWORDS[type]) {
                currentUser = type;
                showMainScreen();
                startRealtimeUpdates();
            } else {
                document.getElementById('loginError').innerHTML = 'âŒ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©';
            }
        };

        // ==================== Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª ====================
        function startRealtimeUpdates() {
            console.log('ğŸ”„ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª');
            
            // ØªØ­Ø¯ÙŠØ« ÙƒÙ„ 3 Ø«ÙˆØ§Ù†ÙŠ (Ù…Ù†Ø§Ø³Ø¨ Ù„Ù„Ù‡ÙˆØ§ØªÙ)
            setInterval(() => {
                if (currentUser) {
                    fetchProjects();
                }
            }, 3000);
            
            // ØªØ­Ø¯ÙŠØ« Ø¹Ù†Ø¯ Ø±Ø¬ÙˆØ¹ Ø§Ù„ØµÙØ­Ø©
            document.addEventListener('visibilitychange', () => {
                if (!document.hidden && currentUser) {
                    fetchProjects();
                }
            });
            
            // ØªØ­Ø¯ÙŠØ« Ø¹Ù†Ø¯ Ø¹ÙˆØ¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„
            window.addEventListener('online', fetchProjects);
            
            // ØªØ­Ø¯ÙŠØ« Ø£ÙˆÙ„ Ù…Ø±Ø©
            fetchProjects();
        }

        // ==================== Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ ====================
        function fetchProjects() {
            if (!currentUser) return;
            
            db.collection('projects')
                .orderBy('timestamp', 'desc')
                .get()
                .then(snapshot => {
                    const newProjects = [];
                    snapshot.forEach(doc => {
                        newProjects.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    
                    projects = newProjects;
                    displayProjects();
                    
                    if (currentUser === 'factory') {
                        updateNotificationCount();
                    }
                })
                .catch(error => console.log('Ø®Ø·Ø£:', error));
        }

        // ==================== Ø¹Ø±Ø¶ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ====================
        function showMainScreen() {
            const isFactory = currentUser === 'factory';
            
            document.getElementById('app').innerHTML = `
                <div class="container">
                    <!-- Ø±Ø£Ø³ Ø§Ù„ØµÙØ­Ø© -->
                    <div class="header">
                        <div style="display: flex; align-items: center; gap: 5px; justify-content: center;">
                            <i class="fas ${isFactory ? 'fa-industry' : 'fa-briefcase'}"></i>
                            <span>${isFactory ? 'Ø§Ù„Ù…Ø¹Ù…Ù„' : 'Ø§Ù„Ù…ÙƒØªØ¨'}</span>
                            <span class="mode-badge">${isMobile ? 'ğŸ“±' : 'ğŸ’»'}</span>
                        </div>
                        <button class="logout-btn" onclick="logout()">Ø®Ø±ÙˆØ¬</button>
                    </div>
                    
                    ${isFactory ? `
                        <!-- Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø¹Ù…Ù„ -->
                        <div class="notifications">
                            <div>
                                <i class="fas fa-bell"></i>
                                <span>Ù„Ø¯ÙŠÙƒ <span id="newOrdersCount">0</span> Ø·Ù„Ø¨Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©</span>
                            </div>
                            <button class="refresh-btn" onclick="forceRefresh()">
                                <i class="fas fa-sync-alt"></i> ØªØ­Ø¯ÙŠØ«
                            </button>
                        </div>
                        
                        <!-- ØªØ¨ÙˆÙŠØ¨Ø§Øª -->
                        <div class="tabs">
                            <button class="tab active" onclick="filterOrders('new')">Ø¬Ø¯ÙŠØ¯Ø©</button>
                            <button class="tab" onclick="filterOrders('inProgress')">Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°</button>
                            <button class="tab" onclick="filterOrders('completed')">Ù…Ù†ØªÙ‡ÙŠØ©</button>
                        </div>
                    ` : `
                        <!-- Ø²Ø± Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù…ÙƒØªØ¨ -->
                        <button class="add-btn" onclick="openAddModal()">
                            <i class="fas fa-plus-circle"></i> Ø¥Ø¶Ø§ÙØ© Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯
                        </button>
                    `}
                    
                    <!-- Ø¨Ø­Ø« -->
                    <div class="search-box">
                        <input type="text" id="searchInput" placeholder="ğŸ” Ø¨Ø­Ø« Ø¹Ù† Ø²Ø¨ÙˆÙ†..." onkeyup="searchProjects()">
                    </div>
                    
                    <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ -->
                    <div id="projectsList" class="projects"></div>
                    
                    ${isMobile && isFactory ? `
                        <!-- Ø²Ø± ØªØ­Ø¯ÙŠØ« ÙƒØ¨ÙŠØ± Ù„Ù„Ù‡ÙˆØ§ØªÙ -->
                        <div class="big-refresh">
                            <button onclick="forceRefresh()">
                                <i class="fas fa-sync-alt"></i> ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¢Ù†
                            </button>
                        </div>
                    ` : ''}
                </div>
                
                <!-- Ù†Ø§ÙØ°Ø© Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ (Ù…Ø¹Ø¯Ù„Ø© Ù„Ù„Ù‡ÙˆØ§ØªÙ) -->
                <div id="projectModal" class="modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 id="modalTitle">â• Ø¥Ø¶Ø§ÙØ© Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</h3>
                            <span class="close" onclick="closeModal()">&times;</span>
                        </div>
                        
                        <form id="projectForm" onsubmit="saveProject(event)">
                            <input type="hidden" id="editId">
                            
                            <div class="form-group">
                                <label><i class="fas fa-user"></i> Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ†</label>
                                <input type="text" id="customerName" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ†" required>
                            </div>
                            
                            <div class="form-group">
                                <label><i class="fas fa-phone"></i> Ø±Ù‚Ù… Ø§Ù„Ø²Ø¨ÙˆÙ†</label>
                                <div class="phone-group">
                                    <span class="phone-prefix">+964</span>
                                    <input type="tel" id="customerPhone" placeholder="77xxxxxxxx" required>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label><i class="fas fa-ruler"></i> Ø§Ù„Ù‚ÙŠØ§Ø³Ø§Øª</label>
                                <textarea id="measurements" rows="2" placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„Ø·ÙˆÙ„ 3Ù…ØŒ Ø§Ù„Ø¹Ø±Ø¶ 2.5Ù…ØŒ Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ 2.2Ù…"></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label><i class="fas fa-palette"></i> Ù„ÙˆÙ† Ø§Ù„Ù…Ø·Ø¨Ø® ÙˆØ§Ù„Ù†Ù‚Ø´Ø©</label>
                                <input type="text" id="color" placeholder="Ù…Ø«Ø§Ù„: Ø£Ø¨ÙŠØ¶ - Ù†Ù‚Ø´Ø© Ø®Ø´Ø¨ÙŠØ©">
                            </div>
                            
                            <div class="form-group">
                                <label><i class="fas fa-door-open"></i> Ù†ÙˆØ¹ Ù‚Ø¨Ø¶Ø§Øª Ø§Ù„Ø¨Ø§Ø¨</label>
                                <input type="text" id="handles" placeholder="Ù…Ø«Ø§Ù„: Ø°Ù‡Ø¨ÙŠØ© / ÙƒØ±ÙˆÙ… / Ø³ÙˆØ¯Ø§Ø¡">
                            </div>
                            
                            <div class="form-group">
                                <label><i class="fas fa-industry"></i> Ø±Ù‚Ù… Ø§Ù„Ù…Ø¹Ù…Ù„ (ÙˆØ§ØªØ³Ø§Ø¨)</label>
                                <div class="phone-group">
                                    <span class="phone-prefix">+964</span>
                                    <input type="tel" id="factoryNumber" value="7700000000" placeholder="77xxxxxxxx">
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label><i class="fas fa-sticky-note"></i> Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©</label>
                                <textarea id="notes" rows="2" placeholder="Ø£ÙŠ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©..."></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label><i class="fas fa-chart-line"></i> Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨</label>
                                <select id="status">
                                    <option value="ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±">â³ ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</option>
                                    <option value="ÙÙŠ Ø§Ù„ØªÙ†ÙÙŠØ°">âš™ï¸ ÙÙŠ Ø§Ù„ØªÙ†ÙÙŠØ°</option>
                                    <option value="Ù…ÙƒØªÙ…Ù„">âœ… Ù…ÙƒØªÙ…Ù„</option>
                                    <option value="ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…">ğŸ“¦ ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…</option>
                                </select>
                            </div>
                            
                            <button type="submit" class="btn-save">
                                <i class="fas fa-save"></i> Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨
                            </button>
                        </form>
                    </div>
                </div>
            `;
        }

        // ==================== Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ ====================
        function displayProjects(filteredProjects = null) {
            const container = document.getElementById('projectsList');
            if (!container) return;
            
            const projectsToShow = filteredProjects || projects;
            
            if (projectsToShow.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:20px; color:#666;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª</div>';
                return;
            }
            
            let html = '';
            projectsToShow.forEach(project => {
                let statusClass = '';
                switch(project.status) {
                    case 'ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±': statusClass = 'planning'; break;
                    case 'ÙÙŠ Ø§Ù„ØªÙ†ÙÙŠØ°': statusClass = 'execution'; break;
                    case 'Ù…ÙƒØªÙ…Ù„': case 'ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…': statusClass = 'completed'; break;
                }
                
                let buttons = '';
                if (currentUser === 'office') {
                    buttons = `
                        <button class="btn btn-edit" onclick="openEditModal('${project.id}')"><i class="fas fa-edit"></i> ØªØ¹Ø¯ÙŠÙ„</button>
                        <button class="btn btn-whatsapp" onclick="sendWhatsApp('${project.id}')"><i class="fab fa-whatsapp"></i> ÙˆØ§ØªØ³Ø§Ø¨</button>
                        <button class="btn btn-delete" onclick="deleteProject('${project.id}')"><i class="fas fa-trash"></i> Ø­Ø°Ù</button>
                    `;
                } else {
                    if (project.status === 'ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±') {
                        buttons = `<button class="btn btn-receive" onclick="updateStatus('${project.id}', 'ÙÙŠ Ø§Ù„ØªÙ†ÙÙŠØ°')"><i class="fas fa-hand-holding-heart"></i> Ø§Ø³ØªÙ„Ø§Ù…</button>`;
                    } else if (project.status === 'ÙÙŠ Ø§Ù„ØªÙ†ÙÙŠØ°') {
                        buttons = `<button class="btn btn-start" onclick="updateStatus('${project.id}', 'Ù…ÙƒØªÙ…Ù„')"><i class="fas fa-check-circle"></i> Ø§ÙƒØªÙ…Ù„</button>`;
                    }
                }
                
                html += `
                    <div class="project-card">
                        <div class="card-header">
                            <span><i class="fas fa-user"></i> ${project.customerName}</span>
                            <span class="status ${statusClass}">${project.status}</span>
                        </div>
                        <div class="card-body">
                            <div class="info">
                                <div class="info-label"><i class="fas fa-phone"></i> Ø§Ù„Ù‡Ø§ØªÙ</div>
                                <div class="info-value">+964 ${project.customerPhone}</div>
                            </div>
                            <div class="info">
                                <div class="info-label"><i class="fas fa-ruler"></i> Ø§Ù„Ù‚ÙŠØ§Ø³Ø§Øª</div>
                                <div class="info-value">${project.measurements || '-'}</div>
                            </div>
                            <div class="info">
                                <div class="info-label"><i class="fas fa-palette"></i> Ø§Ù„Ù„ÙˆÙ†</div>
                                <div class="info-value">${project.color || '-'}</div>
                            </div>
                            <div class="info">
                                <div class="info-label"><i class="fas fa-door-open"></i> Ø§Ù„Ù‚Ø¨Ø¶Ø§Øª</div>
                                <div class="info-value">${project.handles || '-'}</div>
                            </div>
                        </div>
                        <div class="card-footer">
                            ${buttons}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // ==================== ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª ====================
        function updateNotificationCount() {
            const count = projects.filter(p => p.status === 'ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±').length;
            const element = document.getElementById('newOrdersCount');
            if (element) {
                element.textContent = count;
                if (count > (window.lastCount || 0)) {
                    playNotification();
                }
                window.lastCount = count;
            }
        }

        // ==================== ØµÙˆØª ØªÙ†Ø¨ÙŠÙ‡ ====================
        function playNotification() {
            try {
                const audio = new Audio('data:audio/wav;base64,UklGRlwAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YVoAAACAgICAf39/f39/f3+AgICAf39/f3+AgICAf39/f3+AgICAf39/f3+AgICAf39/f3+AgICAf39/f3+AgICAf39/fw==');
                audio.play();
            } catch (e) {}
        }

        // ==================== ØªØ­Ø¯ÙŠØ« Ù‚Ø³Ø±ÙŠ ====================
        window.forceRefresh = () => {
            fetchProjects();
            const btn = event?.target;
            if (btn) {
                const original = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ...';
                setTimeout(() => btn.innerHTML = original, 1000);
            }
        };

        // ==================== ØªØµÙÙŠØ© Ø§Ù„Ø·Ù„Ø¨Ø§Øª ====================
        window.filterOrders = (filter) => {
            let filtered = [];
            switch(filter) {
                case 'new': filtered = projects.filter(p => p.status === 'ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±'); break;
                case 'inProgress': filtered = projects.filter(p => p.status === 'ÙÙŠ Ø§Ù„ØªÙ†ÙÙŠØ°'); break;
                case 'completed': filtered = projects.filter(p => ['Ù…ÙƒØªÙ…Ù„', 'ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…'].includes(p.status)); break;
            }
            displayProjects(filtered);
            
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
        };

        // ==================== Ø¨Ø­Ø« ====================
        window.searchProjects = () => {
            const term = document.getElementById('searchInput')?.value.toLowerCase();
            if (!term) {
                displayProjects();
                return;
            }
            const filtered = projects.filter(p => p.customerName.toLowerCase().includes(term));
            displayProjects(filtered);
        };

        // ==================== ÙØªØ­ Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ø¥Ø¶Ø§ÙØ© ====================
        window.openAddModal = () => {
            if (currentUser !== 'office') {
                alert('Ù‡Ø°Ù‡ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© Ù„Ù„Ù…ÙƒØªØ¨ ÙÙ‚Ø·');
                return;
            }
            
            document.getElementById('modalTitle').innerHTML = 'â• Ø¥Ø¶Ø§ÙØ© Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯';
            document.getElementById('projectForm').reset();
            document.getElementById('editId').value = '';
            document.getElementById('projectModal').style.display = 'block';
            
            // ØªÙ…Ø±ÙŠØ± Ù„Ø£Ø¹Ù„Ù‰ Ø§Ù„Ù†Ø§ÙØ°Ø©
            setTimeout(() => {
                document.querySelector('.modal-content').scrollTop = 0;
            }, 100);
        };

        // ==================== ÙØªØ­ Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ====================
        window.openEditModal = (id) => {
            const project = projects.find(p => p.id === id);
            if (!project) return;
            
            document.getElementById('modalTitle').innerHTML = 'âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨';
            document.getElementById('editId').value = id;
            document.getElementById('customerName').value = project.customerName;
            document.getElementById('customerPhone').value = project.customerPhone;
            document.getElementById('measurements').value = project.measurements || '';
            document.getElementById('color').value = project.color || '';
            document.getElementById('handles').value = project.handles || '';
            document.getElementById('factoryNumber').value = project.factoryNumber;
            document.getElementById('notes').value = project.notes || '';
            document.getElementById('status').value = project.status;
            
            document.getElementById('projectModal').style.display = 'block';
            
            // ØªÙ…Ø±ÙŠØ± Ù„Ø£Ø¹Ù„Ù‰ Ø§Ù„Ù†Ø§ÙØ°Ø©
            setTimeout(() => {
                document.querySelector('.modal-content').scrollTop = 0;
            }, 100);
        };

        // ==================== Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ ====================
        window.closeModal = () => {
            document.getElementById('projectModal').style.display = 'none';
        };

        // ==================== Ø­ÙØ¸ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ ====================
        window.saveProject = async (e) => {
            e.preventDefault();
            
            const editId = document.getElementById('editId').value;
            
            const projectData = {
                customerName: document.getElementById('customerName').value,
                customerPhone: document.getElementById('customerPhone').value.replace(/\D/g, ''),
                measurements: document.getElementById('measurements').value,
                color: document.getElementById('color').value,
                handles: document.getElementById('handles').value,
                factoryNumber: document.getElementById('factoryNumber').value.replace(/\D/g, ''),
                notes: document.getElementById('notes').value,
                status: document.getElementById('status').value,
                timestamp: Date.now()
            };
            
            try {
                if (editId) {
                    await db.collection('projects').doc(editId).update(projectData);
                    alert('âœ… ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­');
                } else {
                    await db.collection('projects').add(projectData);
                    alert('âœ… ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¬Ø§Ø­');
                }
                
                closeModal();
                fetchProjects();
                
            } catch (error) {
                console.error('Error:', error);
                alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸');
            }
        };

        // ==================== ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© ====================
        window.updateStatus = async (id, newStatus) => {
            try {
                await db.collection('projects').doc(id).update({
                    status: newStatus,
                    timestamp: Date.now()
                });
                alert(`âœ… ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø¥Ù„Ù‰: ${newStatus}`);
                fetchProjects();
            } catch (error) {
                console.error('Error:', error);
                alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£');
            }
        };

        // ==================== Ø­Ø°Ù Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ ====================
        window.deleteProject = async (id) => {
            if (currentUser !== 'office') {
                alert('Ù‡Ø°Ù‡ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© Ù„Ù„Ù…ÙƒØªØ¨ ÙÙ‚Ø·');
                return;
            }
            
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ØŸ')) return;
            
            try {
                await db.collection('projects').doc(id).delete();
                alert('âœ… ØªÙ… Ø§Ù„Ø­Ø°Ù Ø¨Ù†Ø¬Ø§Ø­');
                fetchProjects();
            } catch (error) {
                console.error('Error:', error);
                alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù');
            }
        };

        // ==================== Ø¥Ø±Ø³Ø§Ù„ ÙˆØ§ØªØ³Ø§Ø¨ ====================
        window.sendWhatsApp = (id) => {
            const project = projects.find(p => p.id === id);
            if (!project) return;
            
            const message = `Ø·Ù„Ø¨ Ù…Ø·Ø¨Ø®:\nğŸ‘¤ Ø§Ù„Ø²Ø¨ÙˆÙ†: ${project.customerName}\nğŸ“ Ø§Ù„Ù‡Ø§ØªÙ: +964${project.customerPhone}\nğŸ“ Ø§Ù„Ù‚ÙŠØ§Ø³Ø§Øª: ${project.measurements || '-'}\nğŸ¨ Ø§Ù„Ù„ÙˆÙ†: ${project.color || '-'}\nğŸšª Ø§Ù„Ù‚Ø¨Ø¶Ø§Øª: ${project.handles || '-'}`;
            
            window.open(`https://wa.me/964${project.factoryNumber}?text=${encodeURIComponent(message)}`, '_blank');
        };

        // ==================== ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ ====================
        window.logout = () => {
            currentUser = null;
            showLoginScreen();
        };

        // ==================== Ø¨Ø¯Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ====================
        showLoginScreen();

        // ØªØ­Ø°ÙŠØ± Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ù„Ù Ù…Ø­Ù„ÙŠØ§Ù‹
        if (window.location.protocol === 'file:') {
            setTimeout(() => {
                alert('âš ï¸ Ø£Ù†Øª ØªÙØªØ­ Ø§Ù„Ù…Ù„Ù Ù…Ø­Ù„ÙŠØ§Ù‹.\nÙ„Ø¹Ù…Ù„ Ø§Ù„Ù†Ø¸Ø§Ù… Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­ Ø¨ÙŠÙ† Ù‡Ø§ØªÙÙŠÙ†ØŒ Ø§Ø³ØªØ¶Ù Ø§Ù„Ù…Ù„Ù Ø¹Ù„Ù‰ Netlify Ø£Ùˆ GitHub Pages');
            }, 1000);
        }
    </script>
</body>
</html>
