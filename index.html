<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø·Ø§Ø¨Ø® Ø£Ø­Ù…Ø¯ - Ù†Ø¸Ø§Ù… Ù…ØªØ¹Ø¯Ø¯ Ø§Ù„Ù‡ÙˆØ§ØªÙ</title>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: system-ui; }
        body { background: #667eea; padding: 10px; }
        .container { max-width: 600px; margin: 0 auto; background: white; border-radius: 20px; overflow: hidden; }
        
        /* Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ */
        .login-screen { padding: 30px; }
        .login-header { text-align: center; margin-bottom: 30px; }
        .login-header h1 { color: #333; }
        .login-header .online-badge { background: #28a745; color: white; padding: 5px 15px; border-radius: 20px; display: inline-block; margin-top: 10px; }
        
        .login-options { display: flex; gap: 10px; margin-bottom: 20px; }
        .login-option { flex: 1; padding: 20px; border: 2px solid #e0e0e0; border-radius: 10px; text-align: center; }
        .login-option.active { border-color: #667eea; background: #f0f4ff; }
        .login-option i { font-size: 30px; }
        .login-option.office i { color: #667eea; }
        .login-option.factory i { color: #25d366; }
        
        .password-input { margin-bottom: 20px; }
        .password-input input { width: 100%; padding: 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 16px; }
        
        .btn-login { width: 100%; padding: 15px; background: #667eea; color: white; border: none; border-radius: 10px; font-size: 16px; }
        
        /* Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© */
        .header { background: #2b2b2b; color: white; padding: 15px; text-align: center; position: relative; }
        .mode-badge { background: #ffd700; color: #333; padding: 3px 10px; border-radius: 15px; font-size: 12px; }
        .logout-btn { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); background: #dc3545; color: white; border: none; padding: 5px 15px; border-radius: 20px; }
        
        .add-btn { background: #ffd700; color: #333; border: none; padding: 15px; width: 90%; margin: 10px auto; border-radius: 30px; font-size: 16px; display: block; }
        
        .notifications { background: #fff3cd; padding: 10px; margin: 10px; border-radius: 30px; display: flex; justify-content: space-between; align-items: center; }
        .refresh-btn { background: #17a2b8; color: white; border: none; padding: 5px 15px; border-radius: 20px; }
        
        .tabs { display: flex; gap: 5px; padding: 10px; background: #f8f9fa; }
        .tab { flex: 1; padding: 10px; border: none; background: white; border-radius: 5px; }
        .tab.active { background: #667eea; color: white; }
        
        .search-box { padding: 10px; }
        .search-box input { width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 10px; }
        
        .projects { padding: 10px; display: flex; flex-direction: column; gap: 10px; }
        
        .project-card { background: white; border: 1px solid #eee; border-radius: 10px; overflow: hidden; }
        .card-header { background: #667eea; color: white; padding: 10px; display: flex; justify-content: space-between; }
        .status { padding: 3px 8px; border-radius: 15px; font-size: 12px; }
        .status.planning { background: #fff3cd; color: #856404; }
        .status.execution { background: #cce5ff; color: #004085; }
        .status.completed { background: #d4edda; color: #155724; }
        
        .card-body { padding: 10px; }
        .info { margin-bottom: 5px; border-bottom: 1px dashed #eee; padding-bottom: 5px; }
        .info-label { color: #666; font-size: 12px; }
        .info-value { font-weight: 500; }
        
        .card-footer { background: #f8f9fa; padding: 10px; display: flex; gap: 5px; }
        .btn { flex: 1; border: none; padding: 8px; border-radius: 5px; font-size: 12px; }
        .btn-edit { background: #17a2b8; color: white; }
        .btn-whatsapp { background: #25d366; color: white; }
        .btn-delete { background: #dc3545; color: white; }
        .btn-receive { background: #ffd700; color: #333; }
        .btn-start { background: #28a745; color: white; }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); padding: 20px; }
        .modal-content { background: white; padding: 20px; border-radius: 15px; max-width: 500px; margin: 20px auto; }
        
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 5px; }
        
        .phone-group { display: flex; border: 2px solid #e0e0e0; border-radius: 5px; overflow: hidden; }
        .phone-prefix { background: #f0f0f0; padding: 10px; }
        .phone-group input { border: none; flex: 1; }
        
        .close { float: left; font-size: 24px; cursor: pointer; }
        
        .error { color: #dc3545; text-align: center; margin-top: 10px; }
        
        .service-worker-warning { background: #ffc107; color: #333; padding: 10px; margin: 10px; border-radius: 5px; text-align: center; }
    </style>
</head>
<body>
    <div id="app"></div>

    <script>
        // ==================== Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase ====================
        const firebaseConfig = {
            apiKey: "AIzaSyCZfnlCBqBuxao3OTIZAK3E4-J2bAiQWHY",
            authDomain: "ahmad992.firebaseapp.com",
            projectId: "ahmad992",
            storageBucket: "ahmad992.firebasestorage.app",
            messagingSenderId: "349563855282",
            appId: "1:349563855282:web:87479b610f66afd31504ab"
        };

        // ØªÙ‡ÙŠØ¦Ø© Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        // Ù…ØªØºÙŠØ±Ø§Øª Ø¹Ø§Ù…Ø©
        let currentUser = null;
        let projects = [];
        let lastUpdate = Date.now();
        let failedAttempts = 0;

        // ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ±
        const PASSWORDS = {
            office: '1234',
            factory: '5678'
        };

        // ==================== ÙƒØ´Ù Ù†ÙˆØ¹ Ø§Ù„Ø¬Ù‡Ø§Ø² ====================
        const isMobile = /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
        const isOnline = navigator.onLine;

        // ==================== Ø¹Ø±Ø¶ Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ ====================
        function showLoginScreen() {
            document.getElementById('app').innerHTML = `
                <div class="container">
                    <div class="login-screen">
                        <div class="login-header">
                            <h1>ğŸ³ Ù…Ø·Ø§Ø¨Ø® Ø£Ø­Ù…Ø¯</h1>
                            <div class="online-badge">
                                ${isOnline ? 'âœ… Ù…ØªØµÙ„' : 'âŒ ØºÙŠØ± Ù…ØªØµÙ„'}
                            </div>
                        </div>
                        
                        <div class="login-options">
                            <div class="login-option office active" onclick="selectType('office')">
                                <i class="fas fa-briefcase"></i>
                                <div>Ø§Ù„Ù…ÙƒØªØ¨</div>
                            </div>
                            <div class="login-option factory" onclick="selectType('factory')">
                                <i class="fas fa-industry"></i>
                                <div>Ø§Ù„Ù…Ø¹Ù…Ù„</div>
                            </div>
                        </div>
                        
                        <div class="password-input">
                            <input type="password" id="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
                        </div>
                        
                        <button class="btn-login" onclick="login()">
                            Ø¯Ø®ÙˆÙ„
                        </button>
                        
                        <div id="loginError" class="error"></div>
                    </div>
                </div>
            `;
        }

        // ==================== Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ====================
        window.selectType = (type) => {
            document.querySelectorAll('.login-option').forEach(opt => {
                opt.classList.remove('active');
            });
            document.querySelector(`.login-option.${type}`).classList.add('active');
        };

        // ==================== ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ====================
        window.login = () => {
            const selected = document.querySelector('.login-option.active');
            const type = selected.classList.contains('office') ? 'office' : 'factory';
            const password = document.getElementById('password').value;
            
            if (password === PASSWORDS[type]) {
                currentUser = type;
                showMainScreen();
                startRealtimeUpdates();
            } else {
                document.getElementById('loginError').innerHTML = 'âŒ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©';
            }
        };

        // ==================== Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø© ====================
        function startRealtimeUpdates() {
            console.log('ğŸ”„ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø©');
            
            // 1. Ø§Ø³ØªÙ…Ø§Ø¹ Ù…Ø¨Ø§Ø´Ø± (ÙŠØ¹Ù…Ù„ Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙ…Ø¨ÙŠÙˆØªØ± ÙÙ‚Ø·)
            if (!isMobile) {
                db.collection('projects')
                    .orderBy('timestamp', 'desc')
                    .onSnapshot(snapshot => {
                        updateProjectsFromSnapshot(snapshot);
                    }, error => {
                        console.log('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹:', error);
                        startPolling();
                    });
            } else {
                // 2. Ù„Ù„Ù‡ÙˆØ§ØªÙ: Ø§Ø³ØªØ®Ø¯Ø§Ù… Polling ÙƒÙ„ 3 Ø«ÙˆØ§Ù†ÙŠ
                startPolling();
            }
            
            // 3. ØªØ­Ø¯ÙŠØ« Ø¹Ù†Ø¯ Ø¹ÙˆØ¯Ø© Ø§Ù„ØµÙØ­Ø©
            document.addEventListener('visibilitychange', () => {
                if (!document.hidden && currentUser) {
                    console.log('ğŸ‘ï¸ Ø§Ù„ØµÙØ­Ø© Ø¸Ù‡Ø±Øª - ØªØ­Ø¯ÙŠØ«');
                    fetchProjects();
                }
            });
            
            // 4. ØªØ­Ø¯ÙŠØ« Ø¹Ù†Ø¯ Ø¹ÙˆØ¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„
            window.addEventListener('online', () => {
                console.log('ğŸŒ Ø¹Ø§Ø¯ Ø§Ù„Ø§ØªØµØ§Ù„ - ØªØ­Ø¯ÙŠØ«');
                fetchProjects();
            });
        }

        // ==================== Polling Ù„Ù„Ù‡ÙˆØ§ØªÙ ====================
        function startPolling() {
            console.log('ğŸ“± ÙˆØ¶Ø¹ Ø§Ù„Ù‡Ø§ØªÙ - ØªØ­Ø¯ÙŠØ« ÙƒÙ„ 3 Ø«ÙˆØ§Ù†ÙŠ');
            
            // ØªØ­Ø¯ÙŠØ« ÙÙˆØ±ÙŠ Ø£ÙˆÙ„ Ù…Ø±Ø©
            fetchProjects();
            
            // Ø«Ù… ÙƒÙ„ 3 Ø«ÙˆØ§Ù†ÙŠ
            setInterval(() => {
                if (currentUser) {
                    console.log('ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø¯ÙˆØ±ÙŠ:', new Date().toLocaleTimeString());
                    fetchProjects();
                }
            }, 3000);
        }

        // ==================== Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ ====================
        function fetchProjects() {
            if (!currentUser) return;
            
            db.collection('projects')
                .orderBy('timestamp', 'desc')
                .get()
                .then(snapshot => {
                    updateProjectsFromSnapshot(snapshot);
                    failedAttempts = 0;
                })
                .catch(error => {
                    console.log('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¬Ù„Ø¨:', error);
                    failedAttempts++;
                    
                    // Ø¥Ø°Ø§ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ 3 Ù…Ø±Ø§ØªØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ø¨Ø¹Ø¯ 10 Ø«ÙˆØ§Ù†ÙŠ
                    if (failedAttempts >= 3) {
                        setTimeout(fetchProjects, 10000);
                    }
                });
        }

        // ==================== ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ ====================
        function updateProjectsFromSnapshot(snapshot) {
            const newProjects = [];
            snapshot.forEach(doc => {
                newProjects.push({
                    id: doc.id,
                    ...doc.data()
                });
            });
            
            projects = newProjects;
            displayProjects();
            
            if (currentUser === 'factory') {
                updateNotificationCount();
            }
        }

        // ==================== Ø¹Ø±Ø¶ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ====================
        function showMainScreen() {
            const isFactory = currentUser === 'factory';
            
            document.getElementById('app').innerHTML = `
                <div class="container">
                    <!-- Ø±Ø£Ø³ Ø§Ù„ØµÙØ­Ø© -->
                    <div class="header">
                        <div style="display: flex; align-items: center; gap: 5px; justify-content: center;">
                            <i class="fas ${isFactory ? 'fa-industry' : 'fa-briefcase'}"></i>
                            <span>${isFactory ? 'Ø§Ù„Ù…Ø¹Ù…Ù„' : 'Ø§Ù„Ù…ÙƒØªØ¨'}</span>
                            <span class="mode-badge">${isMobile ? 'ğŸ“±' : 'ğŸ’»'}</span>
                        </div>
                        <button class="logout-btn" onclick="logout()">Ø®Ø±ÙˆØ¬</button>
                    </div>
                    
                    ${isFactory ? `
                        <!-- Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø¹Ù…Ù„ -->
                        <div class="notifications">
                            <div>
                                <i class="fas fa-bell"></i>
                                <span>Ù„Ø¯ÙŠÙƒ <span id="newOrdersCount">0</span> Ø·Ù„Ø¨Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©</span>
                            </div>
                            <button class="refresh-btn" onclick="forceRefresh()">
                                <i class="fas fa-sync-alt"></i> ØªØ­Ø¯ÙŠØ«
                            </button>
                        </div>
                        
                        <!-- ØªØ¨ÙˆÙŠØ¨Ø§Øª -->
                        <div class="tabs">
                            <button class="tab active" onclick="filterOrders('new')">Ø¬Ø¯ÙŠØ¯Ø©</button>
                            <button class="tab" onclick="filterOrders('inProgress')">Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°</button>
                            <button class="tab" onclick="filterOrders('completed')">Ù…Ù†ØªÙ‡ÙŠØ©</button>
                        </div>
                    ` : `
                        <!-- Ø²Ø± Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù…ÙƒØªØ¨ -->
                        <button class="add-btn" onclick="openAddModal()">
                            <i class="fas fa-plus-circle"></i> Ø¥Ø¶Ø§ÙØ© Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯
                        </button>
                    `}
                    
                    <!-- Ø¨Ø­Ø« -->
                    <div class="search-box">
                        <input type="text" id="searchInput" placeholder="ğŸ” Ø¨Ø­Ø« Ø¹Ù† Ø²Ø¨ÙˆÙ†..." onkeyup="searchProjects()">
                    </div>
                    
                    <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ -->
                    <div id="projectsList" class="projects"></div>
                    
                    ${isMobile && isFactory ? `
                        <!-- Ø²Ø± ØªØ­Ø¯ÙŠØ« ÙƒØ¨ÙŠØ± Ù„Ù„Ù‡ÙˆØ§ØªÙ -->
                        <div style="padding: 10px;">
                            <button onclick="forceRefresh()" style="width:100%; padding:15px; background:#17a2b8; color:white; border:none; border-radius:30px;">
                                <i class="fas fa-sync-alt"></i> ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¢Ù†
                            </button>
                        </div>
                    ` : ''}
                </div>
                
                <!-- Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ø¥Ø¶Ø§ÙØ©/Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ -->
                <div id="projectModal" class="modal">
                    <div class="modal-content">
                        <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                            <h3 id="modalTitle">Ø¥Ø¶Ø§ÙØ© Ø·Ù„Ø¨</h3>
                            <span class="close" onclick="closeModal()">&times;</span>
                        </div>
                        
                        <form id="projectForm" onsubmit="saveProject(event)">
                            <input type="hidden" id="editId">
                            
                            <div class="form-group">
                                <label>Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ†</label>
                                <input type="text" id="customerName" required>
                            </div>
                            
                            <div class="form-group">
                                <label>Ø±Ù‚Ù… Ø§Ù„Ø²Ø¨ÙˆÙ†</label>
                                <div class="phone-group">
                                    <span class="phone-prefix">+964</span>
                                    <input type="tel" id="customerPhone" required>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>Ø§Ù„Ù‚ÙŠØ§Ø³Ø§Øª</label>
                                <textarea id="measurements" rows="2"></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label>Ø§Ù„Ù„ÙˆÙ† ÙˆØ§Ù„Ù†Ù‚Ø´Ø©</label>
                                <input type="text" id="color">
                            </div>
                            
                            <div class="form-group">
                                <label>Ù‚Ø¨Ø¶Ø§Øª Ø§Ù„Ø¨Ø§Ø¨</label>
                                <input type="text" id="handles">
                            </div>
                            
                            <div class="form-group">
                                <label>Ø±Ù‚Ù… Ø§Ù„Ù…Ø¹Ù…Ù„</label>
                                <div class="phone-group">
                                    <span class="phone-prefix">+964</span>
                                    <input type="tel" id="factoryNumber" value="7700000000">
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
                                <textarea id="notes" rows="2"></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label>Ø§Ù„Ø­Ø§Ù„Ø©</label>
                                <select id="status">
                                    <option value="ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±">ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</option>
                                    <option value="ÙÙŠ Ø§Ù„ØªÙ†ÙÙŠØ°">ÙÙŠ Ø§Ù„ØªÙ†ÙÙŠØ°</option>
                                    <option value="Ù…ÙƒØªÙ…Ù„">Ù…ÙƒØªÙ…Ù„</option>
                                </select>
                            </div>
                            
                            <button type="submit" class="btn-login">Ø­ÙØ¸</button>
                        </form>
                    </div>
                </div>
            `;
            
            // Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹
            fetchProjects();
        }

        // ==================== Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ ====================
        function displayProjects(filteredProjects = null) {
            const container = document.getElementById('projectsList');
            if (!container) return;
            
            const projectsToShow = filteredProjects || projects;
            
            if (projectsToShow.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:20px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª</div>';
                return;
            }
            
            let html = '';
            projectsToShow.forEach(project => {
                let statusClass = '';
                let statusText = project.status;
                
                switch(project.status) {
                    case 'ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±':
                        statusClass = 'planning';
                        break;
                    case 'ÙÙŠ Ø§Ù„ØªÙ†ÙÙŠØ°':
                        statusClass = 'execution';
                        break;
                    case 'Ù…ÙƒØªÙ…Ù„':
                    case 'ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…':
                        statusClass = 'completed';
                        break;
                }
                
                let buttons = '';
                if (currentUser === 'office') {
                    buttons = `
                        <button class="btn btn-edit" onclick="openEditModal('${project.id}')">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
                        <button class="btn btn-whatsapp" onclick="sendWhatsApp('${project.id}')">ğŸ“± ÙˆØ§ØªØ³Ø§Ø¨</button>
                        <button class="btn btn-delete" onclick="deleteProject('${project.id}')">ğŸ—‘ï¸ Ø­Ø°Ù</button>
                    `;
                } else {
                    if (project.status === 'ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±') {
                        buttons = `<button class="btn btn-receive" onclick="updateStatus('${project.id}', 'ÙÙŠ Ø§Ù„ØªÙ†ÙÙŠØ°')">ğŸ“¦ Ø§Ø³ØªÙ„Ø§Ù…</button>`;
                    } else if (project.status === 'ÙÙŠ Ø§Ù„ØªÙ†ÙÙŠØ°') {
                        buttons = `<button class="btn btn-start" onclick="updateStatus('${project.id}', 'Ù…ÙƒØªÙ…Ù„')">âœ… Ø§ÙƒØªÙ…Ù„</button>`;
                    }
                }
                
                html += `
                    <div class="project-card">
                        <div class="card-header">
                            <span>${project.customerName}</span>
                            <span class="status ${statusClass}">${statusText}</span>
                        </div>
                        <div class="card-body">
                            <div class="info">
                                <div class="info-label">ğŸ“ Ø§Ù„Ù‡Ø§ØªÙ</div>
                                <div class="info-value">+964 ${project.customerPhone}</div>
                            </div>
                            <div class="info">
                                <div class="info-label">ğŸ“ Ø§Ù„Ù‚ÙŠØ§Ø³Ø§Øª</div>
                                <div class="info-value">${project.measurements || '-'}</div>
                            </div>
                            <div class="info">
                                <div class="info-label">ğŸ¨ Ø§Ù„Ù„ÙˆÙ†</div>
                                <div class="info-value">${project.color || '-'}</div>
                            </div>
                            <div class="info">
                                <div class="info-label">ğŸšª Ø§Ù„Ù‚Ø¨Ø¶Ø§Øª</div>
                                <div class="info-value">${project.handles || '-'}</div>
                            </div>
                        </div>
                        <div class="card-footer">
                            ${buttons}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // ==================== ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª ====================
        function updateNotificationCount() {
            const count = projects.filter(p => p.status === 'ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±').length;
            const element = document.getElementById('newOrdersCount');
            if (element) {
                element.textContent = count;
                
                // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø·Ù„Ø¨Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©ØŒ Ø´ØºÙ„ ØµÙˆØª
                if (count > 0 && count > (window.lastCount || 0)) {
                    playNotification();
                }
                window.lastCount = count;
            }
        }

        // ==================== ØµÙˆØª ØªÙ†Ø¨ÙŠÙ‡ ====================
        function playNotification() {
            try {
                const audio = new Audio('data:audio/wav;base64,UklGRlwAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YVoAAACAgICAf39/f39/f3+AgICAf39/f3+AgICAf39/f3+AgICAf39/f3+AgICAf39/f3+AgICAf39/f3+AgICAf39/fw==');
                audio.play();
            } catch (e) {}
        }

        // ==================== ØªØ­Ø¯ÙŠØ« Ù‚Ø³Ø±ÙŠ ====================
        window.forceRefresh = () => {
            fetchProjects();
            const btn = event?.target;
            if (btn) {
                const original = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ...';
                setTimeout(() => btn.innerHTML = original, 1000);
            }
        };

        // ==================== ØªØµÙÙŠØ© Ø§Ù„Ø·Ù„Ø¨Ø§Øª ====================
        window.filterOrders = (filter) => {
            let filtered = [];
            
            switch(filter) {
                case 'new':
                    filtered = projects.filter(p => p.status === 'ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±');
                    break;
                case 'inProgress':
                    filtered = projects.filter(p => p.status === 'ÙÙŠ Ø§Ù„ØªÙ†ÙÙŠØ°');
                    break;
                case 'completed':
                    filtered = projects.filter(p => ['Ù…ÙƒØªÙ…Ù„', 'ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…'].includes(p.status));
                    break;
            }
            
            displayProjects(filtered);
            
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
        };

        // ==================== Ø¨Ø­Ø« ====================
        window.searchProjects = () => {
            const term = document.getElementById('searchInput')?.value.toLowerCase();
            if (!term) {
                displayProjects();
                return;
            }
            
            const filtered = projects.filter(p => 
                p.customerName.toLowerCase().includes(term)
            );
            displayProjects(filtered);
        };

        // ==================== ÙØªØ­ Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ø¥Ø¶Ø§ÙØ© ====================
        window.openAddModal = () => {
            if (currentUser !== 'office') {
                alert('Ù‡Ø°Ù‡ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© Ù„Ù„Ù…ÙƒØªØ¨ ÙÙ‚Ø·');
                return;
            }
            
            document.getElementById('modalTitle').innerHTML = 'Ø¥Ø¶Ø§ÙØ© Ø·Ù„Ø¨';
            document.getElementById('projectForm').reset();
            document.getElementById('editId').value = '';
            document.getElementById('projectModal').style.display = 'block';
        };

        // ==================== ÙØªØ­ Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ====================
        window.openEditModal = (id) => {
            const project = projects.find(p => p.id === id);
            if (!project) return;
            
            document.getElementById('modalTitle').innerHTML = 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨';
            document.getElementById('editId').value = id;
            document.getElementById('customerName').value = project.customerName;
            document.getElementById('customerPhone').value = project.customerPhone;
            document.getElementById('measurements').value = project.measurements || '';
            document.getElementById('color').value = project.color || '';
            document.getElementById('handles').value = project.handles || '';
            document.getElementById('factoryNumber').value = project.factoryNumber;
            document.getElementById('notes').value = project.notes || '';
            document.getElementById('status').value = project.status;
            
            document.getElementById('projectModal').style.display = 'block';
        };

        // ==================== Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ ====================
        window.closeModal = () => {
            document.getElementById('projectModal').style.display = 'none';
        };

        // ==================== Ø­ÙØ¸ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ ====================
        window.saveProject = async (e) => {
            e.preventDefault();
            
            const editId = document.getElementById('editId').value;
            
            const projectData = {
                customerName: document.getElementById('customerName').value,
                customerPhone: document.getElementById('customerPhone').value.replace(/\D/g, ''),
                measurements: document.getElementById('measurements').value,
                color: document.getElementById('color').value,
                handles: document.getElementById('handles').value,
                factoryNumber: document.getElementById('factoryNumber').value.replace(/\D/g, ''),
                notes: document.getElementById('notes').value,
                status: document.getElementById('status').value,
                timestamp: Date.now()
            };
            
            try {
                if (editId) {
                    await db.collection('projects').doc(editId).update(projectData);
                    alert('âœ… ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„');
                } else {
                    await db.collection('projects').add(projectData);
                    alert('âœ… ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©');
                    
                    // Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ø¶Ø§ÙØ©ØŒ Ø£Ø±Ø³Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ù…Ø¹Ù…Ù„
                    if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ù…Ø¹Ù…Ù„ØŸ')) {
                        const factoryNumber = projectData.factoryNumber;
                        const message = `Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯: ${projectData.customerName}`;
                        window.open(`https://wa.me/964${factoryNumber}?text=${encodeURIComponent(message)}`, '_blank');
                    }
                }
                
                closeModal();
                fetchProjects();
                
            } catch (error) {
                console.error('Error:', error);
                alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£');
            }
        };

        // ==================== ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© ====================
        window.updateStatus = async (id, newStatus) => {
            try {
                await db.collection('projects').doc(id).update({
                    status: newStatus,
                    timestamp: Date.now()
                });
                
                alert('âœ… ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«');
                fetchProjects();
                
            } catch (error) {
                console.error('Error:', error);
                alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£');
            }
        };

        // ==================== Ø­Ø°Ù Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ ====================
        window.deleteProject = async (id) => {
            if (currentUser !== 'office') {
                alert('Ù‡Ø°Ù‡ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© Ù„Ù„Ù…ÙƒØªØ¨ ÙÙ‚Ø·');
                return;
            }
            
            if (!confirm('ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°ÙØŸ')) return;
            
            try {
                await db.collection('projects').doc(id).delete();
                alert('âœ… ØªÙ… Ø§Ù„Ø­Ø°Ù');
                fetchProjects();
                
            } catch (error) {
                console.error('Error:', error);
                alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£');
            }
        };

        // ==================== Ø¥Ø±Ø³Ø§Ù„ ÙˆØ§ØªØ³Ø§Ø¨ ====================
        window.sendWhatsApp = (id) => {
            const project = projects.find(p => p.id === id);
            if (!project) return;
            
            const message = `Ø·Ù„Ø¨ Ù…Ø·Ø¨Ø®:\nğŸ‘¤ ${project.customerName}\nğŸ“ +964${project.customerPhone}\nğŸ“ ${project.measurements || '-'}\nğŸ¨ ${project.color || '-'}`;
            
            window.open(`https://wa.me/964${project.factoryNumber}?text=${encodeURIComponent(message)}`, '_blank');
        };

        // ==================== ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ ====================
        window.logout = () => {
            currentUser = null;
            showLoginScreen();
        };

        // ==================== Ø¨Ø¯Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ====================
        showLoginScreen();

        // ØªØ­Ø°ÙŠØ± Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ù„Ù ÙŠÙØªØ­ Ù…Ø­Ù„ÙŠØ§Ù‹
        if (window.location.protocol === 'file:') {
            setTimeout(() => {
                alert('âš ï¸ Ø£Ù†Øª ØªÙØªØ­ Ø§Ù„Ù…Ù„Ù Ù…Ø­Ù„ÙŠØ§Ù‹.\nÙ„Ø¹Ù…Ù„ Ø§Ù„Ù†Ø¸Ø§Ù… Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­ Ø¨ÙŠÙ† Ù‡Ø§ØªÙÙŠÙ†ØŒ Ø§Ø³ØªØ¶Ù Ø§Ù„Ù…Ù„Ù Ø¹Ù„Ù‰ GitHub Pages Ø£Ùˆ Netlify');
            }, 1000);
        }
    </script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</body>
</html>