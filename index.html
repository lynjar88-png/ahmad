<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Ù…Ø·Ø§Ø¨Ø® Ø£Ø­Ù…Ø¯ - Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© V11</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root {
            --primary: #667eea; --urgent: #e11d48; --bg: #f8fafc; --text: #1e293b;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; }
        
        .app-container { display: flex; flex-direction: column; height: 100vh; max-width: 600px; margin: 0 auto; background: white; }
        
        /* Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ */
        .login-screen { padding: 40px 20px; text-align: center; }
        .login-card { border: 2px solid #e2e8f0; padding: 20px; border-radius: 20px; margin-bottom: 20px; cursor: pointer; transition: 0.3s; }
        .login-card.active { border-color: var(--primary); background: #f0f4ff; }
        .btn-login { width: 100%; padding: 15px; background: var(--primary); color: white; border: none; border-radius: 12px; font-size: 18px; font-weight: bold; }

        /* Ø§Ù„Ø±Ø£Ø³ ÙˆØ§Ù„Ù‚Ø§Ø¦Ù…Ø© */
        header { background: #2d3748; color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; }
        .stats-bar { display: flex; gap: 10px; padding: 10px; background: #edf2f7; overflow-x: auto; white-space: nowrap; }
        .stat-item { background: white; padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; border: 1px solid #e2e8f0; }

        .main-content { flex: 1; overflow-y: auto; padding: 10px; background: #f1f5f9; }
        
        /* ÙƒØ§Ø±Øª Ø§Ù„Ø·Ù„Ø¨ */
        .order-card { background: white; border-radius: 15px; padding: 15px; margin-bottom: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border-right: 5px solid #cbd5e1; position: relative; }
        .order-card.urgent { border-right-color: var(--urgent); }
        .order-card.completed { opacity: 0.6; background: #f8fafc; }
        .order-header { display: flex; justify-content: space-between; margin-bottom: 10px; }
        .area-tag { background: #e0f2fe; color: #0369a1; padding: 2px 8px; border-radius: 6px; font-size: 11px; font-weight: bold; }
        .order-time { font-size: 11px; color: #64748b; }

        /* Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
        .actions { display: flex; gap: 8px; margin-top: 15px; }
        .btn { flex: 1; padding: 10px; border: none; border-radius: 8px; font-weight: bold; font-size: 13px; cursor: pointer; }
        .btn-done { background: #10b981; color: white; }
        .btn-process { background: #3b82f6; color: white; }
        .btn-del { background: #fee2e2; color: #ef4444; flex: 0 0 40px; }

        /* Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¥Ø¶Ø§ÙØ© */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 100; align-items: center; justify-content: center; padding: 20px; }
        .modal-content { background: white; width: 100%; border-radius: 20px; padding: 20px; max-height: 90vh; overflow-y: auto; }
        input, select, textarea { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #e2e8f0; border-radius: 10px; background: #f8fafc; }
        
        .floating-add { position: fixed; bottom: 20px; left: 20px; width: 60px; height: 60px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4); border: none; }
    </style>
</head>
<body>

<div id="app" class="app-container">
    </div>

<script>
    // 1. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase (ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø·Ø§Ø¨Ù‚ØªÙ‡Ø§ Ù„Ù…Ø´Ø±ÙˆØ¹Ùƒ)
    const firebaseConfig = {
        apiKey: "AIzaSyCZfnlCBqBuxao3OTIZAK3E4-J2bAiQWHY",
        authDomain: "ahmad992.firebaseapp.com",
        projectId: "ahmad992",
        storageBucket: "ahmad992.firebasestorage.app",
        messagingSenderId: "349563855282",
        appId: "1:349563855282:web:87479b610f66afd31504ab"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    let currentUser = null;
    let regions = ["Ø§Ù„Ù…Ù†ØµÙˆØ±", "Ø§Ù„ÙƒØ±Ø§Ø¯Ø©", "Ø§Ù„Ø¯ÙˆØ±Ø©", "Ø²ÙŠÙˆÙ†Ø©", "Ø­ÙŠ Ø§Ù„Ø¬Ø§Ù…Ø¹Ø©"];

    // 2. Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„
    function showLogin() {
        document.getElementById('app').innerHTML = `
            <div class="login-screen">
                <h2 style="margin-bottom:30px;">ğŸ³ Ù†Ø¸Ø§Ù… Ù…Ø·Ø§Ø¨Ø® Ø£Ø­Ù…Ø¯</h2>
                <div class="login-card active" id="card-office" onclick="selectRole('office')">
                    <i class="fas fa-briefcase fa-2x" style="color:#667eea"></i>
                    <h3>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙƒØªØ¨</h3>
                </div>
                <div class="login-card" id="card-factory" onclick="selectRole('factory')">
                    <i class="fas fa-industry fa-2x" style="color:#10b981"></i>
                    <h3>Ù‚Ø³Ù… Ø§Ù„Ù…Ø¹Ù…Ù„</h3>
                </div>
                <input type="password" id="pass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" style="text-align:center;">
                <button class="btn-login" onclick="attemptLogin()">Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù†Ø¸Ø§Ù…</button>
            </div>
        `;
    }

    window.selectRole = (role) => {
        document.querySelectorAll('.login-card').forEach(c => c.classList.remove('active'));
        document.getElementById(`card-${role}`).classList.add('active');
    };

    window.attemptLogin = () => {
        const role = document.getElementById('card-office').classList.contains('active') ? 'office' : 'factory';
        const pass = document.getElementById('pass').value;
        const correctPass = (role === 'office') ? '1234' : '5678';

        if(pass === correctPass) {
            currentUser = role;
            showMain();
            startSync(); // Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ù„Ø­Ø¸ÙŠØ© ÙÙˆØ± Ø§Ù„Ø¯Ø®ÙˆÙ„
        } else {
            alert("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©!");
        }
    };

    // 3. Ø´Ø§Ø´Ø© Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
    function showMain() {
        document.getElementById('app').innerHTML = `
            <header>
                <span>${currentUser === 'office' ? 'ğŸ¢ Ø§Ù„Ù…ÙƒØªØ¨' : 'ğŸ­ Ø§Ù„Ù…Ø¹Ù…Ù„'}</span>
                <button onclick="location.reload()" style="background:none; border:1px solid white; color:white; padding:4px 10px; border-radius:5px;">Ø®Ø±ÙˆØ¬</button>
            </header>
            <div class="stats-bar">
                <div class="stat-item">ğŸ“¦ Ø·Ù„Ø¨Ø§Øª: <span id="s-all">0</span></div>
                <div class="stat-item" style="color:#3b82f6;">â³ Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°: <span id="s-proc">0</span></div>
                <div class="stat-item" style="color:#10b981;">âœ… Ù…ÙƒØªÙ…Ù„: <span id="s-done">0</span></div>
            </div>
            <div class="main-content" id="orders-list">
                <div style="text-align:center; margin-top:50px; color:#94a3b8;">Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>
            </div>
            ${currentUser === 'office' ? '<button class="floating-add" onclick="openModal()">â•</button>' : ''}
            
            <div id="m-add" class="modal">
                <div class="modal-content">
                    <h3 style="margin-bottom:15px; color:var(--primary);">Ø¥Ø¶Ø§ÙØ© Ø·Ù„Ø¨ Ù‚ÙŠØ§Ø³</h3>
                    <select id="f-region">${regions.map(r => `<option>${r}</option>`).join('')}</select>
                    <input type="text" id="f-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ†">
                    <input type="number" id="f-price" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ">
                    <textarea id="f-details" placeholder="Ø§Ù„Ù‚ÙŠØ§Ø³Ø§Øª ÙˆØ§Ù„ØªÙØ§ØµÙŠÙ„..."></textarea>
                    <div style="display:flex; align-items:center; gap:10px; margin:10px 0;">
                        <input type="checkbox" id="f-urgent" style="width:20px;"> <label style="color:red; font-weight:bold;">Ø·Ù„Ø¨ Ø¹Ø§Ø¬Ù„ ğŸ”´</label>
                    </div>
                    <button class="btn-login" onclick="saveOrder()">Ø­ÙØ¸ ÙˆØ¥Ø±Ø³Ø§Ù„ Ù„Ù„Ù…Ø¹Ù…Ù„</button>
                    <button onclick="closeModal()" style="width:100%; background:none; border:none; margin-top:10px; color:#64748b;">Ø¥Ù„ØºØ§Ø¡</button>
                </div>
            </div>
        `;
    }

    // 4. Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ù„Ø­Ø¸ÙŠØ© (Ø§Ù„Ù‚Ù„Ø¨ Ø§Ù„Ù†Ø§Ø¨Ø¶ Ù„Ù„Ù†Ø¸Ø§Ù…)
    function startSync() {
        // onSnapshot ØªØ¶Ù…Ù† Ø£Ù† Ø£ÙŠ ØªØºÙŠÙŠØ± ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙŠØ¸Ù‡Ø± ÙÙˆØ±Ø§Ù‹ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©
        db.collection('orders').orderBy('createdAt', 'desc')
        .onSnapshot(snapshot => {
            const list = document.getElementById('orders-list');
            list.innerHTML = '';
            let stats = { all:0, proc:0, done:0 };

            snapshot.forEach(doc => {
                const o = doc.data();
                const id = doc.id;
                stats.all++;
                if(o.status === 'done') stats.done++;
                if(o.status === 'processing') stats.proc++;

                const card = document.createElement('div');
                card.className = `order-card ${o.urgent ? 'urgent' : ''} ${o.status === 'done' ? 'completed' : ''}`;
                
                let actionBtn = '';
                if(currentUser === 'factory') {
                    if(o.status === 'pending') actionBtn = `<button class="btn btn-process" onclick="updateStatus('${id}', 'processing')">Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ù…Ø®Ø·Ø·</button>`;
                    else if(o.status === 'processing') actionBtn = `<button class="btn btn-done" onclick="updateStatus('${id}', 'done')">ØªÙ… Ø§Ù„Ø¥ÙƒÙ…Ø§Ù„ âœ…</button>`;
                }

                card.innerHTML = `
                    <div class="order-header">
                        <span class="area-tag">${o.region}</span>
                        <span class="order-time">${o.time || ''}</span>
                    </div>
                    <div style="font-weight:bold; font-size:16px;">${o.customerName}</div>
                    <div style="font-size:13px; color:#475569; margin:5px 0;">${o.details}</div>
                    <div style="color:#059669; font-weight:bold;">${parseInt(o.price).toLocaleString()} Ø¯.Ø¹</div>
                    <div class="actions">
                        ${actionBtn}
                        ${currentUser === 'office' ? `<button class="btn btn-del" onclick="deleteOrder('${id}')"><i class="fas fa-trash"></i></button>` : ''}
                    </div>
                `;
                list.appendChild(card);
            });

            document.getElementById('s-all').innerText = stats.all;
            document.getElementById('s-proc').innerText = stats.proc;
            document.getElementById('s-done').innerText = stats.done;
        }, err => {
            console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©:", err);
            alert("ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ù„Ø­Ø¸ÙŠØŒ ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª");
        });
    }

    // 5. Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª (Ø¥Ø¶Ø§ÙØ©ØŒ ØªØ­Ø¯ÙŠØ«ØŒ Ø­Ø°Ù)
    window.openModal = () => document.getElementById('m-add').style.display = 'flex';
    window.closeModal = () => document.getElementById('m-add').style.display = 'none';

    window.saveOrder = async () => {
        const name = document.getElementById('f-name').value;
        const region = document.getElementById('f-region').value;
        const price = document.getElementById('f-price').value;
        const details = document.getElementById('f-details').value;
        const urgent = document.getElementById('f-urgent').checked;

        if(!name || !price) return alert("ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ø³Ø¹Ø±");

        try {
            await db.collection('orders').add({
                customerName: name,
                region: region,
                price: price,
                details: details,
                urgent: urgent,
                status: 'pending',
                time: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}),
                createdAt: firebase.firestore.FieldValue.serverTimestamp() // ØªÙˆÙ‚ÙŠØª Ø§Ù„Ø³ÙŠØ±ÙØ± Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©
            });
            closeModal();
        } catch (e) { alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸"); }
    };

    window.updateStatus = async (id, newStatus) => {
        try {
            await db.collection('orders').doc(id).update({ status: newStatus });
        } catch (e) { alert("ÙØ´Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«"); }
    };

    window.deleteOrder = async (id) => {
        if(confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ")) {
            await db.collection('orders').doc(id).delete();
        }
    };

    // ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
    showLogin();
</script>

</body>
</html>
